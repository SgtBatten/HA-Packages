#### COMBINED MOTION/LOCK SENSORS #####################################################
#### Source: https://community.home-assistant.io/t/wildcard-entities-card/72969/3
#######################################################################################
template:
  - sensor:
      - name: Motion Summary
        state: >
          {%-for bs in states.binary_sensor| selectattr('attributes.device_class','defined')|selectattr('attributes.device_class', 'eq', 'motion')|selectattr('state', 'eq', 'on')|selectattr('attributes.device_class', 'eq', 'motion') |map(attribute="name")|list
            if bs-%}
              {%-if loop.last-%}
                {%-if loop.index > 0-%}
                    {{ bs | replace(' Motion Sensor', '') | replace(' Motion', '')}}{%-if not loop.last -%}{%-if(loop.index+1==loop.length)%} & {%else%}, {%endif-%}{%-else%} motion{%endif-%}
                {%-endif-%}
              {%-endif-%}
            {%-else-%}
              No motion
          {%-endfor-%}
        icon: >
          {% if states.binary_sensor| selectattr('attributes.device_class','defined')|selectattr('attributes.device_class', 'eq', 'motion')|selectattr('state', 'eq', 'on')|map(attribute="name")|list|length %}
            mdi:run-fast
          {%-else-%}
            mdi:motion-sensor-off
          {%-endif-%}

      # DOORS
      - name: Door Summary
        state: >
          {%-for bs in states.binary_sensor| selectattr('attributes.device_class','defined')|selectattr('attributes.device_class', 'search', 'door')|selectattr('state', 'eq', 'on') |map(attribute='name')|list
            if bs -%}
              {%-if loop.last-%}
                {%-if loop.index > 0-%}
                  {{bs}}{%-if not loop.last -%}{%-if(loop.index+1==loop.length)%} & {%else%}, {%endif-%}{%-else%} open{%endif-%}
                {%-endif-%}
              {%-endif-%}
            {%-else-%}
              All Closed
          {%-endfor-%}
        icon: >
          {%- if states.binary_sensor| selectattr('attributes.device_class','defined')|selectattr('attributes.device_class', 'search', 'door')|selectattr('state', 'eq', 'on') |map(attribute='name')|list %}
          mdi:door-open
          {%-else-%}
          mdi:door-closed
          {%-endif-%}
        attributes:
          count: "{{states.binary_sensor| selectattr('attributes.device_class','defined')|selectattr('attributes.device_class', 'search', 'door')|selectattr('state', 'eq', 'on') |map(attribute='name')|list|length}}"

        # LIGHTS
      - name: Light Summary
        state: >
          {% for light in states.light |selectattr('state', 'eq', 'on')|rejectattr('entity_id', 'search', 'infra_red_lights_in_night_mode')|map(attribute='name')|list
            if light -%}
              {%-if loop.last-%}
                {%-if loop.index > 0-%}
                  {{light}}{%-if not loop.last -%}{%-if(loop.index+1==loop.length)%} & {%else%}, {%endif-%}{%-else%} on{%endif-%}
                {%-endif-%}
              {%-endif-%}
            {%-else-%}
              All off
          {%-endfor-%}
        icon: >
          {%- if states.light |selectattr('state', 'eq', 'on')|rejectattr('entity_id', 'search', 'infra_red_lights_in_night_mode')|map(attribute='name')|list|length %}
            mdi:lightbulb-on
          {%-else-%}
            mdi:lightbulb-off
          {%-endif-%}
        attributes:
          count: "{{states.light |selectattr('state', 'eq', 'on')|rejectattr('entity_id', 'search', 'infra_red_lights_in_night_mode')|map(attribute='name')|list|length }}"

        # CLIMATE
      - name: Climate Summary
        state: >
          {%-for state in states.climate
            if not state.state=="off" and not state.state=="unavailable"-%}
              {%-if loop.last-%}
                {%-if loop.index > 0-%}
                  {%-for state in states.climate if not state.state =="off" and not state.state=="unavailable" and not state.name == "Aircon" -%}
                    {{state.name | replace('A/C', '')}}{%-if not loop.last -%}{%-if(loop.index+1==loop.length)%} & {%else%}, {%endif-%}{%-else%} on{%endif-%}
                  {%-endfor-%}
                {%-endif-%}
              {%-endif-%}
            {%-else-%}
              All off
          {%-endfor-%}
        icon: >
          {%-for state in states.climate
            if not state.state=="off" and not state.state=="unavailable"-%}
              {%-if loop.last-%}
                {%-if loop.index > 0-%}
                    mdi:air-conditioner
                {%-endif-%}
              {%-endif-%}
            {%-else-%}
              mdi:hvac-off
          {%-endfor-%}
        attributes:
          count: |-
            {%-for state in states.climate
              if not state.state=="off" and not state.state=="unavailable" and not state.name == "Aircon"-%}
                {%-if loop.last-%}
                  {%-if loop.index > 0-%}
                    {{ loop.length }}
                  {%-endif-%}
                {%-endif-%}
              {%-else-%}
                0
            {%-endfor-%}

      #### LOW BATTERY SENSOR ###############################################################
      #### Source: https://community.home-assistant.io/t/wildcard-entities-card/72969/3
      #######################################################################################
      - name: Low Battery Summary
        state: >
          {%-for state in states.sensor if(state.attributes.device_class=="battery" and state.state | int(0) <= 25)-%}
              {%-if loop.last-%}
                {%-if loop.index > 0-%}
                  {%-for state in states.sensor if(state.attributes.device_class=="battery" and state.state | int(0) <= 25)-%}
                    {{state.name | replace('Battery Level', '')| replace('battery', '')| replace('Battery', '')}}{%-if not loop.last -%}{%-if(loop.index+1==loop.length)%} & {%else%}, {%endif-%}{%-else%} low{%endif-%}
                  {%-endfor-%}
                {%-endif-%}
              {%-endif-%}
            {%-else-%}
              Everything is charged
          {%-endfor-%}
        icon: >
          {%-for state in states.sensor
            if(state.attributes.device_class=="battery" and state.state | int(0) <= 25)-%}
              {%-if loop.last-%}
                {%-if loop.index > 0-%}
                    mdi:battery-10
                {%-endif-%}
              {%-endif-%}
            {%-else-%}
              mdi:battery
          {%-endfor-%}
